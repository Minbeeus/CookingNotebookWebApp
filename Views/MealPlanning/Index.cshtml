@model List<CookingNotebookWebApp.Models.MealTime>
@{
    ViewData["Title"] = "L·∫≠p K·∫ø Ho·∫°ch B·ªØa ƒÇn";
    Layout = "~/Pages/Shared/_Layout.cshtml";
}

@section Styles {
<link rel="stylesheet" href="~/css/MealPlanning/index.css" />
}

<div class="meal-planning-wrapper">
    <div class="meal-planning-container">
        <!-- Header -->
        <div class="header-section">
            <h1>üßë‚Äçüç≥ Tr·ª£ l√Ω B·ªØa ƒÉn Th√¥ng minh</h1>
            <p>H√£y cho t√¥i bi·∫øt nhu c·∫ßu c·ªßa b·∫°n, t√¥i s·∫Ω gi√∫p b·∫°n l√™n m·ªôt k·∫ø ho·∫°ch b·ªØa ƒÉn th·∫≠t ho√†n h·∫£o!</p>
        </div>

        <!-- Form Input -->
        <div class="form-section">
            <form id="mealPlanForm">
                <!-- S·ªë ng√†y -->
                <div class="form-group">
                    <label>üìÖ B·∫°n mu·ªën l·∫≠p k·∫ø ho·∫°ch cho bao nhi√™u ng√†y?</label>
                    <div class="stepper">
                        <button type="button" class="stepper-btn" id="decreaseNumDays">‚àí</button>
                        <div class="stepper-display" id="numDaysDisplay">7</div>
                        <button type="button" class="stepper-btn" id="increaseNumDays">+</button>
                    </div>
                    <input type="hidden" id="numDays" name="numDays" value="7">
                </div>

                <!-- S·ªë ng∆∞·ªùi -->
                <div class="form-group">
                    <label>üë• D√†nh cho bao nhi√™u ng∆∞·ªùi ƒÉn?</label>
                    <div class="stepper">
                        <button type="button" class="stepper-btn" id="decreaseNumPeople">‚àí</button>
                        <div class="stepper-display" id="numPeopleDisplay">2</div>
                        <button type="button" class="stepper-btn" id="increaseNumPeople">+</button>
                    </div>
                    <input type="hidden" id="numPeople" name="numPeople" value="2">
                </div>

                <!-- B·ªØa ƒÉn -->
                <div class="form-group">
                    <label>üçΩÔ∏è B·∫°n mu·ªën l√™n k·∫ø ho·∫°ch cho c√°c b·ªØa n√†o?</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="mealTime1" name="mealTimes" value="1" checked>
                            <label for="mealTime1">
                                <span class="emoji">‚òÄÔ∏è</span>
                                <span>B·ªØa S√°ng</span>
                            </label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="mealTime2" name="mealTimes" value="2" checked>
                            <label for="mealTime2">
                                <span class="emoji">ü•ó</span>
                                <span>B·ªØa Tr∆∞a</span>
                            </label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="mealTime3" name="mealTimes" value="3" checked>
                            <label for="mealTime3">
                                <span class="emoji">üåô</span>
                                <span>B·ªØa T·ªëi</span>
                            </label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="mealTime4" name="mealTimes" value="4">
                            <label for="mealTime4">
                                <span class="emoji">ü•®</span>
                                <span>ƒÇn nh·∫π</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Y√™u c·∫ßu ƒë·∫∑c bi·ªát -->
                <div class="form-group">
                    <label>üéØ Y√™u c·∫ßu ƒë·∫∑c bi·ªát? (T√πy ch·ªçn)</label>
                    <input type="text" id="restrictionsInput" placeholder="V√≠ d·ª•: Chay, Nhanh, Kh√¥ng cay... (nh·∫≠p v√† nh·∫•n Enter)" class="multiselect-input">
                    <div class="tag-input-container" id="restrictionsContainer">
                        <!-- Tags s·∫Ω ƒë∆∞·ª£c th√™m t·∫°i ƒë√¢y -->
                    </div>
                    <input type="hidden" id="restrictions" name="restrictions" value="">
                </div>

                <!-- Error message -->
                <div class="error-message" id="errorMessage"></div>

                <!-- Submit button -->
                <button type="submit" class="submit-btn" id="submitBtn">
                    <span class="loading-spinner" id="spinner"></span>
                    <span id="btnText">üí° T·∫°o K·∫ø Ho·∫°ch Ngay!</span>
                </button>
            </form>
        </div>

        <!-- Result Section -->
        <div class="result-section" id="resultSection">
            <div class="tabs">
                <button type="button" class="tab-button active" data-tab="mealPlan">üìÖ L·ªãch B·ªØa ƒÇn</button>
                <button type="button" class="tab-button" data-tab="shoppingList">üõí Danh S√°ch Mua S·∫Øm</button>
            </div>

            <!-- Tab: Meal Plan -->
            <div class="tab-content active" id="mealPlanTab">
                <div id="mealPlanContent">
                    <!-- Meal plan s·∫Ω ƒë∆∞·ª£c th√™m t·∫°i ƒë√¢y -->
                </div>
            </div>

            <!-- Tab: Shopping List -->
            <div class="tab-content" id="shoppingListTab">
                <div id="shoppingListContent" class="shopping-list">
                    <!-- Shopping list s·∫Ω ƒë∆∞·ª£c th√™m t·∫°i ƒë√¢y -->
                </div>
                <div class="action-buttons">
                    <button type="button" class="action-btn" onclick="printShoppingList()">üñ®Ô∏è In Danh S√°ch</button>
                    <button type="button" class="action-btn" onclick="emailShoppingList()">‚úâÔ∏è G·ª≠i Email</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    const USER_ID = 1; // Thay b·∫±ng current user ID t·ª´ session

    // Stepper functions
    function updateStepper(inputId, displayId, value, min = 1, max = 30) {
        const input = document.getElementById(inputId);
        const display = document.getElementById(displayId);
        const newValue = Math.max(min, Math.min(max, value));
        input.value = newValue;
        display.textContent = newValue;
        return newValue;
    }

    document.getElementById('increaseNumDays').addEventListener('click', (e) => {
        e.preventDefault();
        const current = parseInt(document.getElementById('numDays').value);
        updateStepper('numDays', 'numDaysDisplay', current + 1);
    });

    document.getElementById('decreaseNumDays').addEventListener('click', (e) => {
        e.preventDefault();
        const current = parseInt(document.getElementById('numDays').value);
        updateStepper('numDays', 'numDaysDisplay', current - 1);
    });

    document.getElementById('increaseNumPeople').addEventListener('click', (e) => {
        e.preventDefault();
        const current = parseInt(document.getElementById('numPeople').value);
        updateStepper('numPeople', 'numPeopleDisplay', current + 1, 1, 50);
    });

    document.getElementById('decreaseNumPeople').addEventListener('click', (e) => {
        e.preventDefault();
        const current = parseInt(document.getElementById('numPeople').value);
        updateStepper('numPeople', 'numPeopleDisplay', current - 1, 1, 50);
    });

    // Restrictions tag input
    document.getElementById('restrictionsInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            const value = e.target.value.trim();
            if (value) {
                addRestrictionTag(value);
                e.target.value = '';
            }
        }
    });

    function addRestrictionTag(text) {
        const container = document.getElementById('restrictionsContainer');
        const tag = document.createElement('div');
        tag.className = 'tag';
        tag.innerHTML = `
            <span>${text}</span>
            <span class="tag-remove" onclick="this.parentElement.remove(); updateRestrictionsInput();">√ó</span>
        `;
        container.appendChild(tag);
        updateRestrictionsInput();
    }

    function updateRestrictionsInput() {
        const tags = document.querySelectorAll('.tag span:first-child');
        const restrictions = Array.from(tags).map(t => t.textContent);
        document.getElementById('restrictions').value = JSON.stringify(restrictions);
    }

    // Form submit
    document.getElementById('mealPlanForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const numDays = parseInt(document.getElementById('numDays').value);
        const numPeople = parseInt(document.getElementById('numPeople').value);
        const mealTimes = Array.from(document.querySelectorAll('input[name="mealTimes"]:checked')).map(cb => parseInt(cb.value));
        const restrictions = JSON.parse(document.getElementById('restrictions').value || '[]');

        // Validation
        const errorMsg = document.getElementById('errorMessage');
        if (numDays < 1 || numDays > 30) {
            errorMsg.textContent = '‚ö†Ô∏è S·ªë ng√†y ph·∫£i t·ª´ 1 ƒë·∫øn 30';
            errorMsg.classList.add('show');
            return;
        }
        if (numPeople < 1) {
            errorMsg.textContent = '‚ö†Ô∏è S·ªë ng∆∞·ªùi ph·∫£i l·ªõn h∆°n 0';
            errorMsg.classList.add('show');
            return;
        }
        if (mealTimes.length === 0) {
            errorMsg.textContent = '‚ö†Ô∏è Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 b·ªØa ƒÉn';
            errorMsg.classList.add('show');
            return;
        }
        errorMsg.classList.remove('show');

        // Show loading
        const btn = document.getElementById('submitBtn');
        const spinner = document.getElementById('spinner');
        const btnText = document.getElementById('btnText');
        btn.disabled = true;
        spinner.style.display = 'inline-block';
        btnText.textContent = 'ƒêang t·∫°o k·∫ø ho·∫°ch...';

        try {
            const response = await fetch('/api/mealplanning/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    userId: USER_ID,
                    numDays: numDays,
                    numPeople: numPeople,
                    mealTimeIds: mealTimes,
                    restrictions: restrictions
                })
            });

            const data = await response.json();

            if (data.success) {
                displayResults(data.mealPlan, data.shoppingList);
                document.getElementById('resultSection').classList.add('show');
                window.scrollTo({ top: document.getElementById('resultSection').offsetTop - 100, behavior: 'smooth' });
            } else {
                errorMsg.textContent = '‚ö†Ô∏è ' + data.message;
                errorMsg.classList.add('show');
            }
        } catch (error) {
            errorMsg.textContent = '‚ö†Ô∏è L·ªói: ' + error.message;
            errorMsg.classList.add('show');
        } finally {
            btn.disabled = false;
            spinner.style.display = 'none';
            btnText.textContent = 'üí° T·∫°o K·∫ø Ho·∫°ch Ngay!';
        }
    });

    // Display Results
    function displayResults(mealPlan, shoppingList) {
        displayMealPlan(mealPlan);
        displayShoppingList(shoppingList);
    }

    function displayMealPlan(mealPlan) {
        if (!mealPlan || mealPlan.length === 0) {
            document.getElementById('mealPlanContent').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìÖ</div>Kh√¥ng t√¨m th·∫•y k·∫ø ho·∫°ch b·ªØa ƒÉn</div>';
            return;
        }

        let html = '';
        let currentDay = 0;

        for (const meal of mealPlan) {
            if (meal.day !== currentDay) {
                currentDay = meal.day;
                html += `<div class="day-header">üìÖ Ng√†y ${currentDay}</div>`;
            }

            const mealType = getMealType(meal.mealName);
            const cardClass = `meal-card ${mealType}`;
            const rating = meal.rating ? `‚≠ê ${meal.rating}/5` : '‚≠ê 4.5/5';
            const prepTime = meal.prepTime || '10';
            const cookTime = meal.cookTime || '20';

            html += `
                <div class="${cardClass}">
                    <div class="recipe-item">
                        <div class="recipe-image">
                            ${meal.imageUrl ? `<img src="${meal.imageUrl}" alt="${meal.recipeTitle}">` : '<div style="background: #e0e0e0; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; color: #999; font-size: 2em;">üçΩÔ∏è</div>'}
                        </div>
                        <div class="recipe-info">
                            <div class="recipe-title">${getMealEmoji(meal.mealName)} ${meal.mealName} - ${meal.recipeTitle}</div>
                            <div class="recipe-rating">${rating}</div>
                            <div class="recipe-time">‚è±Ô∏è Prep: ${prepTime} ph√∫t | Cook: ${cookTime} ph√∫t</div>
                            <div class="recipe-actions">
                                <a href="/Recipe/Details/${meal.recipeId}" class="recipe-link">Xem chi ti·∫øt ‚ûî</a>
                                <button class="recipe-btn" onclick="changeRecipe(${meal.day}, '${meal.mealName}')">üîÑ ƒê·ªïi m√≥n</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        document.getElementById('mealPlanContent').innerHTML = html;
    }

    function getMealEmoji(mealName) {
        if (mealName.includes('S√°ng') || mealName.includes('Breakfast')) return '‚òÄÔ∏è';
        if (mealName.includes('Tr∆∞a') || mealName.includes('Lunch')) return 'ü•ó';
        if (mealName.includes('T·ªëi') || mealName.includes('Dinner')) return 'üåô';
        if (mealName.includes('nh·∫π') || mealName.includes('Snack')) return 'ü•®';
        return 'üçΩÔ∏è';
    }

    function getMealType(mealName) {
        if (mealName.includes('S√°ng') || mealName.includes('Breakfast')) return 'breakfast';
        if (mealName.includes('Tr∆∞a') || mealName.includes('Lunch')) return 'lunch';
        if (mealName.includes('T·ªëi') || mealName.includes('Dinner')) return 'dinner';
        return '';
    }

    function displayShoppingList(shoppingList) {
        if (!shoppingList || shoppingList.length === 0) {
            document.getElementById('shoppingListContent').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üõí</div>Danh s√°ch mua s·∫Øm tr·ªëng</div>';
            return;
        }

        // Group by ingredient type with proper categorization
        const grouped = {};
        const categoryIcons = {
            'Th·ªãt & H·∫£i s·∫£n': 'üçñ',
            'Rau c·ªß': 'ü•¨',
            'Gia v·ªã & Kh√°c': 'üßÇ',
            'Ng≈© c·ªëc & B√°nh': 'üåæ',
            'S·ªØa & Ph√¥ mai': 'ü•õ',
            'Kh√°c': 'üè™'
        };

        for (const item of shoppingList) {
            // Determine category based on ingredient
            let type = 'Kh√°c';
            const name = (item.ingredientName || '').toLowerCase();
            
            if (name.includes('th·ªãt') || name.includes('g√†') || name.includes('c√°') || name.includes('t√¥m') || name.includes('cua') || name.includes('m·ª±c')) {
                type = 'Th·ªãt & H·∫£i s·∫£n';
            } else if (name.includes('rau') || name.includes('c·∫£i') || name.includes('c√†') || name.includes('c≈©') || name.includes('khoai') || name.includes('c√† r·ªët')) {
                type = 'Rau c·ªß';
            } else if (name.includes('n∆∞·ªõc m·∫Øm') || name.includes('t·ªèi') || name.includes('h√†nh') || name.includes('gia v·ªã') || name.includes('d·∫ßu') || name.includes('mu·ªëi') || name.includes('ƒë∆∞·ªùng')) {
                type = 'Gia v·ªã & Kh√°c';
            } else if (name.includes('g·∫°o') || name.includes('b√°nh') || name.includes('m√¨') || name.includes('c∆°m')) {
                type = 'Ng≈© c·ªëc & B√°nh';
            } else if (name.includes('s·ªØa') || name.includes('ph√¥ mai') || name.includes('butter')) {
                type = 'S·ªØa & Ph√¥ mai';
            }
            
            if (!grouped[type]) grouped[type] = [];
            grouped[type].push(item);
        }

        let html = '';
        for (const [type, items] of Object.entries(grouped)) {
            const icon = categoryIcons[type] || 'üè™';
            html += `<div class="ingredient-group">
                <div class="ingredient-group-title">${icon} ${type}</div>`;
            
            for (const item of items) {
                const quantity = item.totalQuantity || item.quantity || '1';
                const unit = item.unit || '';
                html += `
                    <div class="ingredient-item">
                        <input type="checkbox" onchange="this.parentElement.classList.toggle('checked')">
                        <div class="ingredient-info">
                            <div class="ingredient-name">${item.ingredientName || 'Kh√¥ng r√µ'}</div>
                            <div class="ingredient-quantity">${quantity} ${unit}</div>
                        </div>
                    </div>
                `;
            }
            html += '</div>';
        }

        document.getElementById('shoppingListContent').innerHTML = html;
    }

    // Tab switching
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const tab = e.target.dataset.tab;
            
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            e.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
        });
    });

    // Action functions
    function changeRecipe(day, mealName) {
        const errorMsg = document.getElementById('errorMessage');
        errorMsg.textContent = 'üí° T√≠nh nƒÉng ƒë·ªïi m√≥n s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t trong phi√™n b·∫£n ti·∫øp theo';
        errorMsg.classList.add('show');
        setTimeout(() => {
            errorMsg.classList.remove('show');
        }, 3000);
    }

    function printShoppingList() {
        const printWindow = window.open('', '', 'width=800,height=600');
        const content = document.getElementById('shoppingListContent').innerHTML;
        
        const styles = `
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                h2 { color: #f28c38; margin-bottom: 20px; }
                .ingredient-group { margin-bottom: 20px; }
                .ingredient-group-title { font-weight: bold; color: #f28c38; margin-bottom: 10px; font-size: 1.1em; }
                .ingredient-item { display: flex; margin-bottom: 8px; }
                .ingredient-name { font-weight: 500; min-width: 200px; }
                .ingredient-quantity { color: #666; }
                @@media print { 
                    body { margin: 0; } 
                    .ingredient-item { page-break-inside: avoid; }
                }
            </style>
        `;
        
        printWindow.document.write(`<!DOCTYPE html><html><head>${styles}</head><body>`);
        printWindow.document.write('<h2>üõí Danh S√°ch Mua S·∫Øm</h2>');
        printWindow.document.write(content);
        printWindow.document.write('</body></html>');
        printWindow.document.close();
        printWindow.print();
    }

    function emailShoppingList() {
        const errorMsg = document.getElementById('errorMessage');
        errorMsg.textContent = 'üí° T√≠nh nƒÉng g·ª≠i email s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t trong phi√™n b·∫£n ti·∫øp theo';
        errorMsg.classList.add('show');
        setTimeout(() => {
            errorMsg.classList.remove('show');
        }, 3000);
    }
</script>
}
